# æ—¥å¿—ç³»ç»Ÿé…ç½®æŒ‡å—

## æ¦‚è¿° âœ… **ç³»ç»Ÿå·²å®Œæˆéƒ¨ç½²**

æœ¬é¡¹ç›®é‡‡ç”¨ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒæ¨¡å—åŒ–é…ç½®å’Œå¤šç§è¿è¡Œæ¨¡å¼ã€‚æ‰€æœ‰æ—¥å¿—é€šè¿‡YAMLé…ç½®æ–‡ä»¶è¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œæ”¯æŒçµæ´»çš„æ ¼å¼åŒ–ã€çº§åˆ«æ§åˆ¶å’Œæ–‡ä»¶è½®è½¬ã€‚

**ğŸ“… å®Œæˆæ—¶é—´**: 2025å¹´7æœˆ17æ—¥  
**ğŸ¯ å®æ–½çŠ¶æ€**: 100%å®Œæˆï¼Œæ‰€æœ‰5ä¸ªæ¨¡å—å·²å…¨é¢éƒ¨ç½²ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ  
**ğŸ”„ åŠŸèƒ½ç‰¹æ€§**: æ”¯æŒæ—¥å¿—æ»šåŠ¨ã€åŒé‡æ—¥å¿—æœºåˆ¶ã€ä»»åŠ¡ç‰¹å®šæ—¥å¿—

## æ—¥å¿—æ¶æ„

### ç›®å½•ç»“æ„
```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ logging_config.yaml         # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ logs/                           # ç»Ÿä¸€æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ app.log                     # ä¸»åº”ç”¨æ—¥å¿—
â”‚   â”œâ”€â”€ agent.log                   # æ™ºèƒ½ä»£ç†æ—¥å¿—
â”‚   â”œâ”€â”€ vanna.log                   # Vannaæ¡†æ¶æ—¥å¿—
â”‚   â”œâ”€â”€ data_pipeline.log           # æ•°æ®ç®¡é“æ—¥å¿—
â”‚   â””â”€â”€ react_agent.log             # React Agentæ—¥å¿—
â”œâ”€â”€ core/logging/                   # æ ¸å¿ƒæ—¥å¿—ç®¡ç†
â”‚   â”œâ”€â”€ __init__.py                 # ç»Ÿä¸€å…¥å£API
â”‚   â””â”€â”€ log_manager.py              # æ—¥å¿—ç®¡ç†å™¨
â””â”€â”€ data_pipeline/training_data/    # ä»»åŠ¡ç‰¹å®šæ—¥å¿—
    â””â”€â”€ {task_id}/
        â””â”€â”€ data_pipeline.log       # ä»»åŠ¡ä¸“ç”¨æ—¥å¿—
```

### æ¨¡å—åˆ†ç±» âœ… **å…¨éƒ¨å·²å®ç°**

| æ¨¡å— | æ—¥å¿—æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|----------|------|------|
| **app** | `app.log` | âœ… å·²éƒ¨ç½² | ä¸»åº”ç”¨ç¨‹åºã€APIå…¥å£ï¼ˆunified_api.pyï¼‰ã€é€šç”¨åŠŸèƒ½ |
| **agent** | `agent.log` | âœ… å·²éƒ¨ç½² | æ™ºèƒ½ä»£ç†ç›¸å…³åŠŸèƒ½ï¼ˆagent/*ï¼‰ |
| **vanna** | `vanna.log` | âœ… å·²éƒ¨ç½² | Vannaæ¡†æ¶ç›¸å…³ï¼ˆcore/*, customllm/*ï¼‰ |
| **data_pipeline** | `data_pipeline.log` | âœ… å·²éƒ¨ç½² | æ•°æ®å¤„ç†ç®¡é“ï¼ˆdata_pipeline/*ï¼‰ |
| **react_agent** | `react_agent.log` | âœ… å·²éƒ¨ç½² | React Agentæ¨¡å—ï¼ˆreact_agent/*ï¼‰ |

**ğŸ“Š ç»Ÿè®¡**: 5ä¸ªæ¨¡å—ï¼Œ100%å®Œæˆç»Ÿä¸€æ—¥å¿—éƒ¨ç½²

## é…ç½®æ–‡ä»¶è¯¦è§£

### ä¸»é…ç½®æ–‡ä»¶ï¼šconfig/logging_config.yaml

#### å…¨å±€é…ç½®
```yaml
version: 1

# å…¨å±€é…ç½®
global:
  base_level: INFO    # å…¨å±€åŸºç¡€æ—¥å¿—çº§åˆ«
```

#### é»˜è®¤é…ç½®
```yaml
default:
  level: INFO         # é»˜è®¤æ—¥å¿—çº§åˆ«
  console:
    enabled: true     # æ˜¯å¦å¯ç”¨æ§åˆ¶å°è¾“å‡º
    level: INFO       # æ§åˆ¶å°æ—¥å¿—çº§åˆ«
    format: "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
  file:
    enabled: true     # æ˜¯å¦å¯ç”¨æ–‡ä»¶è¾“å‡º
    level: DEBUG      # æ–‡ä»¶æ—¥å¿—çº§åˆ«
    filename: "app.log"
    format: "%(asctime)s [%(levelname)s] [%(name)s] [user:%(user_id)s] [session:%(session_id)s] %(filename)s:%(lineno)d - %(message)s"
    rotation:
      enabled: true   # æ˜¯å¦å¯ç”¨æ—¥å¿—è½®è½¬
      max_size: "50MB"
      backup_count: 10
```

#### æ¨¡å—ç‰¹å®šé…ç½®

##### Appæ¨¡å—
```yaml
modules:
  app:
    level: INFO
    console:
      enabled: true
      level: INFO
      format: "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
    file:
      enabled: true
      level: DEBUG
      filename: "app.log"
      format: "%(asctime)s [%(levelname)s] [%(name)s] [user:%(user_id)s] [session:%(session_id)s] %(filename)s:%(lineno)d - %(message)s"
      rotation:
        enabled: true
        max_size: "50MB"
        backup_count: 10
```

##### Agentæ¨¡å—
```yaml
  agent:
    level: DEBUG
    console:
      enabled: true
      level: INFO
      format: "%(asctime)s [%(levelname)s] Agent: %(message)s"
    file:
      enabled: true
      level: DEBUG
      filename: "agent.log"
      format: "%(asctime)s [%(levelname)s] [%(name)s] [user:%(user_id)s] [session:%(session_id)s] %(filename)s:%(lineno)d - %(message)s"
      rotation:
        enabled: true
        max_size: "30MB"
        backup_count: 8
```

##### Data Pipelineæ¨¡å—
```yaml
  data_pipeline:
    level: DEBUG
    console:
      enabled: true
      level: INFO
      format: "%(asctime)s [%(levelname)s] Pipeline: %(message)s"
    file:
      enabled: true
      level: DEBUG
      filename: "data_pipeline.log"
      format: "%(asctime)s [%(levelname)s] [%(name)s] %(filename)s:%(lineno)d - %(message)s"
      rotation:
        enabled: true
        max_size: "20MB"
        backup_count: 5
```

##### React Agentæ¨¡å—
```yaml
  react_agent:
    level: DEBUG
    console:
      enabled: true
      level: INFO
      format: "%(asctime)s [%(levelname)s] ReactAgent: %(message)s"
    file:
      enabled: true
      level: DEBUG
      filename: "react_agent.log"
      format: "%(asctime)s [%(levelname)s] [%(name)s] [user:%(user_id)s] [session:%(session_id)s] %(filename)s:%(lineno)d - %(message)s"
      rotation:
        enabled: true
        max_size: "30MB"
        backup_count: 8
```

### é…ç½®å‚æ•°è¯´æ˜

#### æ—¥å¿—çº§åˆ«
- `DEBUG`: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- `INFO`: ä¸€èˆ¬ä¿¡æ¯
- `WARNING`: è­¦å‘Šä¿¡æ¯
- `ERROR`: é”™è¯¯ä¿¡æ¯
- `CRITICAL`: ä¸¥é‡é”™è¯¯

#### æ ¼å¼åŒ–å­—ç¬¦ä¸²
- `%(asctime)s`: æ—¶é—´æˆ³
- `%(levelname)s`: æ—¥å¿—çº§åˆ«
- `%(name)s`: Loggeråç§°
- `%(message)s`: æ—¥å¿—æ¶ˆæ¯
- `%(filename)s`: æ–‡ä»¶å
- `%(lineno)d`: è¡Œå·
- `%(user_id)s`: ç”¨æˆ·IDï¼ˆä¸Šä¸‹æ–‡ï¼‰
- `%(session_id)s`: ä¼šè¯IDï¼ˆä¸Šä¸‹æ–‡ï¼‰

#### æ–‡ä»¶è½®è½¬
- `enabled`: æ˜¯å¦å¯ç”¨è½®è½¬
- `max_size`: å•ä¸ªæ–‡ä»¶æœ€å¤§å¤§å°
- `backup_count`: ä¿ç•™çš„å¤‡ä»½æ–‡ä»¶æ•°é‡

## Data Pipeline ç‰¹æ®Šé…ç½® âœ… **å·²å®Œæˆå®ç°**

### åŒé‡æ—¥å¿—æœºåˆ¶

Data Pipelineæ¨¡å—æ”¯æŒåŒé‡æ—¥å¿—æœºåˆ¶ï¼ˆå·²å…¨é¢å®ç°ï¼‰ï¼š

1. **å…¨å±€æ—¥å¿—**: å†™å…¥ `logs/data_pipeline.log` âœ…
2. **ä»»åŠ¡ç‰¹å®šæ—¥å¿—**: å†™å…¥ `data_pipeline/training_data/{task_id}/data_pipeline.log` âœ…
3. **æ»šåŠ¨åŠŸèƒ½**: å…¨å±€æ—¥å¿—20MB/5å¤‡ä»½ï¼Œä»»åŠ¡æ—¥å¿—10MB/3å¤‡ä»½ âœ…

### ä½¿ç”¨æ–¹æ³•

#### åŸºç¡€ç”¨æ³•
```python
from data_pipeline.dp_logging import init_data_pipeline_logging, get_logger

# åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
init_data_pipeline_logging()

# è·å–åŸºç¡€loggerï¼ˆä»…å†™å…¥å…¨å±€æ—¥å¿—ï¼‰
logger = get_logger("ComponentName")
logger.info("è¿™æ¡æ—¥å¿—ä¼šå†™å…¥ logs/data_pipeline.log")
```

#### ä»»åŠ¡ç‰¹å®šæ—¥å¿—
```python
from data_pipeline.dp_logging import init_data_pipeline_logging, get_logger

# åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
init_data_pipeline_logging()

# è·å–ä»»åŠ¡ç‰¹å®šloggerï¼ˆåŒæ—¶å†™å…¥å…¨å±€å’Œä»»åŠ¡æ—¥å¿—ï¼‰
task_id = "task_20250717_160000"
logger = get_logger("ComponentName", task_id)

# è¿™æ¡æ—¥å¿—ä¼šåŒæ—¶å†™å…¥ä¸¤ä¸ªåœ°æ–¹ï¼š
# 1. logs/data_pipeline.log
# 2. data_pipeline/training_data/task_20250717_160000/data_pipeline.log
logger.info("å¤„ç†ä»»åŠ¡å¼€å§‹")
```

### ä»»åŠ¡ç›®å½•ç»“æ„
```
data_pipeline/training_data/
â”œâ”€â”€ task_20250717_160000/
â”‚   â”œâ”€â”€ data_pipeline.log          # ä»»åŠ¡ä¸“ç”¨æ—¥å¿—
â”‚   â”œâ”€â”€ task_config.json
â”‚   â”œâ”€â”€ task_result.json
â”‚   â””â”€â”€ å…¶ä»–ä»»åŠ¡æ–‡ä»¶...
â”œâ”€â”€ task_20250717_170000/
â”‚   â”œâ”€â”€ data_pipeline.log          # å¦ä¸€ä¸ªä»»åŠ¡çš„æ—¥å¿—
â”‚   â””â”€â”€ å…¶ä»–ä»»åŠ¡æ–‡ä»¶...
â””â”€â”€ ...
```

### APIå’Œå‘½ä»¤è¡Œæ¨¡å¼

#### APIæ¨¡å¼
```python
# åœ¨APIè°ƒç”¨ä¸­ä½¿ç”¨
from data_pipeline.dp_logging import init_data_pipeline_logging, get_logger

def process_data_api(task_id: str):
    init_data_pipeline_logging()
    logger = get_logger("DataProcessor", task_id)
    
    logger.info("APIæ¨¡å¼ï¼šå¼€å§‹å¤„ç†æ•°æ®")
    # å¤„ç†é€»è¾‘...
    logger.info("APIæ¨¡å¼ï¼šæ•°æ®å¤„ç†å®Œæˆ")
```

#### å‘½ä»¤è¡Œæ¨¡å¼
```python
# åœ¨å‘½ä»¤è¡Œè„šæœ¬ä¸­ä½¿ç”¨
from data_pipeline.dp_logging import init_data_pipeline_logging, get_logger

def main():
    task_id = "manual_20250717_160000"
    init_data_pipeline_logging()
    logger = get_logger("TrainingScript", task_id)
    
    logger.info("å‘½ä»¤è¡Œæ¨¡å¼ï¼šå¼€å§‹è®­ç»ƒ")
    # è®­ç»ƒé€»è¾‘...
    logger.info("å‘½ä»¤è¡Œæ¨¡å¼ï¼šè®­ç»ƒå®Œæˆ")

if __name__ == "__main__":
    main()
```

## ç¼–ç¨‹æ¥å£ âœ… **å…¨éƒ¨å¯ç”¨**

### æ ¸å¿ƒAPI

#### åˆå§‹åŒ–
```python
from core.logging import initialize_logging

# åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿï¼ˆä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶ï¼‰
initialize_logging()

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
initialize_logging("custom_config.yaml")
```

#### è·å–Logger
```python
from core.logging import (
    get_app_logger,
    get_agent_logger, 
    get_vanna_logger,
    get_data_pipeline_logger,
    get_react_agent_logger
)

# è·å–ä¸åŒæ¨¡å—çš„logger
app_logger = get_app_logger("ComponentName")
agent_logger = get_agent_logger("ComponentName")
vanna_logger = get_vanna_logger("ComponentName")
data_logger = get_data_pipeline_logger("ComponentName")
react_logger = get_react_agent_logger("ComponentName")
```

#### ä¸Šä¸‹æ–‡ç®¡ç†
```python
from core.logging import set_log_context, clear_log_context

# è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯
set_log_context(user_id="user123", session_id="sess456")

# æ¸…é™¤ä¸Šä¸‹æ–‡
clear_log_context()
```

### ä½¿ç”¨ç¤ºä¾‹

#### åŸºæœ¬ç”¨æ³•
```python
from core.logging import initialize_logging, get_app_logger

# åˆå§‹åŒ–
initialize_logging()

# è·å–logger
logger = get_app_logger("MyComponent")

# è®°å½•æ—¥å¿—
logger.debug("è°ƒè¯•ä¿¡æ¯")
logger.info("ä¸€èˆ¬ä¿¡æ¯")
logger.warning("è­¦å‘Šä¿¡æ¯")
logger.error("é”™è¯¯ä¿¡æ¯")
logger.critical("ä¸¥é‡é”™è¯¯")
```

#### ä¸Šä¸‹æ–‡ä½¿ç”¨
```python
from core.logging import initialize_logging, get_app_logger, set_log_context

initialize_logging()
logger = get_app_logger("APIHandler")

# è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
set_log_context(user_id="user123", session_id="sess456")

# è¿™æ¡æ—¥å¿—ä¼šåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
logger.info("ç”¨æˆ·è¯·æ±‚å¤„ç†å¼€å§‹")
```

## é…ç½®è‡ªå®šä¹‰

### åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶

1. å¤åˆ¶ `config/logging_config.yaml` ä¸ºæ–°æ–‡ä»¶
2. ä¿®æ”¹é…ç½®å‚æ•°
3. ä½¿ç”¨è‡ªå®šä¹‰é…ç½®åˆå§‹åŒ–ï¼š

```python
from core.logging import initialize_logging
initialize_logging("config/custom_logging.yaml")
```

### åŠ¨æ€é…ç½®è°ƒæ•´

```python
from core.logging import get_logger

# è·å–loggerååŠ¨æ€è°ƒæ•´çº§åˆ«
logger = get_logger("MyComponent", "app")
logger.setLevel(logging.DEBUG)
```

## æœ€ä½³å®è·µ

### 1. æ—¥å¿—çº§åˆ«é€‰æ‹©
- **DEBUG**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»…åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨
- **INFO**: ç¨‹åºæ­£å¸¸è¿è¡Œçš„å…³é”®ä¿¡æ¯
- **WARNING**: æ½œåœ¨é—®é¢˜ï¼Œä½†ä¸å½±å“ç¨‹åºè¿è¡Œ
- **ERROR**: é”™è¯¯æƒ…å†µï¼Œä½†ç¨‹åºå¯ä»¥ç»§ç»­è¿è¡Œ
- **CRITICAL**: ä¸¥é‡é”™è¯¯ï¼Œç¨‹åºå¯èƒ½æ— æ³•ç»§ç»­è¿è¡Œ

### 2. æ¶ˆæ¯æ ¼å¼è§„èŒƒ
```python
# æ¨èæ ¼å¼
logger.info("ç”¨æˆ·ç™»å½•æˆåŠŸ", extra={"user_id": "123"})
logger.error("æ•°æ®åº“è¿æ¥å¤±è´¥", extra={"error": str(e)})

# é¿å…æ ¼å¼
logger.info("ç”¨æˆ·123ç™»å½•æˆåŠŸ")  # ä¸æ˜“äºæŸ¥è¯¢å’Œåˆ†æ
```

### 3. å¼‚å¸¸å¤„ç†
```python
try:
    # ä¸šåŠ¡é€»è¾‘
    result = process_data()
    logger.info("æ•°æ®å¤„ç†æˆåŠŸ")
except Exception as e:
    logger.error(f"æ•°æ®å¤„ç†å¤±è´¥: {e}", exc_info=True)
    raise
```

### 4. æ€§èƒ½è€ƒè™‘
```python
# å¯¹äºé¢‘ç¹è°ƒç”¨çš„DEBUGæ—¥å¿—ï¼Œä½¿ç”¨æ¡ä»¶åˆ¤æ–­
if logger.isEnabledFor(logging.DEBUG):
    logger.debug(f"å¤æ‚è®¡ç®—ç»“æœ: {expensive_operation()}")
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ—¥å¿—æ–‡ä»¶ä¸ç”Ÿæˆ
- æ£€æŸ¥ `logs/` ç›®å½•æƒé™
- ç¡®è®¤é…ç½®æ–‡ä»¶è·¯å¾„æ­£ç¡®
- éªŒè¯ `initialize_logging()` å·²è°ƒç”¨

#### 2. æ§åˆ¶å°æ— è¾“å‡º
- æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­ `console.enabled` è®¾ç½®
- ç¡®è®¤æ—¥å¿—çº§åˆ«è®¾ç½®æ­£ç¡®

#### 3. æ—¥å¿—æ ¼å¼å¼‚å¸¸
- æ£€æŸ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²è¯­æ³•
- ç¡®è®¤ä¸Šä¸‹æ–‡å˜é‡å·²æ­£ç¡®è®¾ç½®

### è°ƒè¯•æ–¹æ³•

#### å¯ç”¨è°ƒè¯•æ¨¡å¼
```python
import logging
logging.basicConfig(level=logging.DEBUG)

from core.logging import initialize_logging
initialize_logging()
```

#### æŸ¥çœ‹é…ç½®åŠ è½½æƒ…å†µ
```python
from core.logging import _log_manager
print(_log_manager.config)
```

## æ€»ç»“ âœ… **ç³»ç»Ÿå…¨é¢è¿è¡Œ**

æœ¬é¡¹ç›®çš„æ—¥å¿—ç³»ç»Ÿå·²æˆåŠŸæä¾›äº†çµæ´»ã€å¯æ‰©å±•çš„æ—¥å¿—ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡ç»Ÿä¸€çš„é…ç½®æ–‡ä»¶å’Œæ¨¡å—åŒ–çš„è®¾è®¡ï¼Œå®ç°äº†ä¸åŒæ¨¡å—çš„ç‹¬ç«‹æ—¥å¿—ç®¡ç†éœ€æ±‚ã€‚Data Pipelineæ¨¡å—çš„åŒé‡æ—¥å¿—æœºåˆ¶ç‰¹åˆ«é€‚åˆéœ€è¦ä»»åŠ¡è¿½è¸ªçš„åœºæ™¯ã€‚

### ğŸ¯ å®æ–½å®Œæˆæƒ…å†µ
- âœ… **5ä¸ªæ¨¡å—**: appã€agentã€vannaã€data_pipelineã€react_agent
- âœ… **100%æ»šåŠ¨æ”¯æŒ**: æ‰€æœ‰æ—¥å¿—æ–‡ä»¶å‡æ”¯æŒè‡ªåŠ¨æ»šåŠ¨
- âœ… **åŒé‡æ—¥å¿—æœºåˆ¶**: Data Pipelineæ”¯æŒå…¨å±€+ä»»åŠ¡ç‰¹å®šæ—¥å¿—
- âœ… **ç»Ÿä¸€API**: æä¾›å®Œæ•´çš„ç¼–ç¨‹æ¥å£
- âœ… **é…ç½®æ–‡ä»¶**: å•ä¸€YAMLé…ç½®ç®¡ç†æ‰€æœ‰æ¨¡å—

### ğŸš€ ç³»ç»Ÿä¼˜åŠ¿
æ­£ç¡®ä½¿ç”¨æ—¥å¿—ç³»ç»Ÿå¯ä»¥å¤§å¤§æé«˜é—®é¢˜è¯Šæ–­æ•ˆç‡å’Œç³»ç»Ÿå¯ç»´æŠ¤æ€§ã€‚å½“å‰ç³»ç»Ÿå·²åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å……åˆ†åˆ©ç”¨ä¸åŒçº§åˆ«çš„æ—¥å¿—è®°å½•ï¼Œä¸ºç›‘æ§å’Œæ•…éšœæ’é™¤æä¾›æœ‰åŠ›æ”¯æŒã€‚

**éƒ¨ç½²å®Œæˆæ—¶é—´**: 2025å¹´7æœˆ17æ—¥  
**ç³»ç»ŸçŠ¶æ€**: ç”Ÿäº§å°±ç»ªï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ