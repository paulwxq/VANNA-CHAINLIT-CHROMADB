[
  {
    "question": "各服务区每日总营收排名（按日期和金额排序）",
    "sql": "SELECT oper_date AS 日期, service_name AS 服务区名称, SUM(pay_sum) AS 总营收 FROM bss_business_day_data WHERE delete_ts IS NULL GROUP BY oper_date, service_name ORDER BY 日期, 总营收 DESC;"
  },
  {
    "question": "最近7天各服务区平均订单金额（总支付金额/订单总数）",
    "sql": "SELECT service_name AS 服务区名称, SUM(pay_sum)/SUM(order_sum) AS 平均订单金额 FROM bss_business_day_data WHERE oper_date >= CURRENT_DATE - 7 AND oper_date < CURRENT_DATE AND delete_ts IS NULL GROUP BY service_name ORDER BY 平均订单金额 DESC;"
  },
  {
    "question": "每月微信支付占比变化趋势（微信金额/总支付金额）",
    "sql": "SELECT TO_CHAR(oper_date, 'YYYY-MM') AS 月份, SUM(wx)/SUM(pay_sum)*100 AS 微信支付占比 FROM bss_business_day_data WHERE delete_ts IS NULL GROUP BY TO_CHAR(oper_date, 'YYYY-MM') ORDER BY 月份;"
  },
  {
    "question": "支付宝订单占比最高的服务区（支付宝订单数/总订单数）",
    "sql": "SELECT service_name AS 服务区名称, SUM(zf_order)/SUM(order_sum)*100 AS 支付宝订单占比 FROM bss_business_day_data WHERE delete_ts IS NULL GROUP BY service_name ORDER BY 支付宝订单占比 DESC LIMIT 1;"
  },
  {
    "question": "各公司下属服务区的月营收对比（关联公司表）",
    "sql": "SELECT c.company_name AS 公司名称, TO_CHAR(b.oper_date, 'YYYY-MM') AS 月份, SUM(b.pay_sum) AS 总营收 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL GROUP BY c.company_name, 月份 ORDER BY 月份, 总营收 DESC;"
  },
  {
    "question": "哪些服务区存在现金支付且订单量低于整体平均订单量",
    "sql": "SELECT service_name AS 服务区名称, oper_date AS 日期, order_sum AS 订单量 FROM bss_business_day_data WHERE rmb > 0 AND order_sum < (SELECT AVG(order_sum) FROM bss_business_day_data WHERE delete_ts IS NULL) AND delete_ts IS NULL ORDER BY 订单量 DESC;"
  },
  {
    "question": "行吧支付方式的使用趋势（按周统计支付总额）",
    "sql": "SELECT TO_CHAR(oper_date, 'YYYY-IW') AS 周数, SUM(xs) AS 行吧支付总额 FROM bss_business_day_data WHERE delete_ts IS NULL GROUP BY TO_CHAR(oper_date, 'YYYY-IW') ORDER BY 周数;"
  },
  {
    "question": "每个服务区最高日营收记录（按营收降序排列）",
    "sql": "SELECT service_name AS 服务区名称, oper_date AS 日期, pay_sum AS 营收 FROM bss_business_day_data WHERE delete_ts IS NULL AND (service_name, pay_sum) IN (SELECT service_name, MAX(pay_sum) FROM bss_business_day_data WHERE delete_ts IS NULL GROUP BY service_name) ORDER BY 营收 DESC;"
  },
  {
    "question": "周末与工作日的平均营收对比（按星期维度统计）",
    "sql": "SELECT CASE WHEN EXTRACT(ISODOW FROM oper_date) IN (6,7) THEN '周末' ELSE '工作日' END AS 日期类型, AVG(pay_sum) AS 平均营收 FROM bss_business_day_data WHERE delete_ts IS NULL GROUP BY 日期类型 ORDER BY 平均营收 DESC;"
  },
  {
    "question": "庐山服务区最近一天的支付方式占比分布（各支付方式金额比例）",
    "sql": "SELECT '微信' AS 支付方式, wx/pay_sum*100 AS 占比 FROM bss_business_day_data WHERE service_name = '庐山服务区' AND delete_ts IS NULL ORDER BY oper_date DESC LIMIT 1 UNION ALL SELECT '支付宝', zfb/pay_sum*100 FROM bss_business_day_data WHERE service_name = '庐山服务区' AND delete_ts IS NULL ORDER BY oper_date DESC LIMIT 1 UNION ALL SELECT '现金', rmb/pay_sum*100 FROM bss_business_day_data WHERE service_name = '庐山服务区' AND delete_ts IS NULL ORDER BY oper_date DESC LIMIT 1 UNION ALL SELECT '行吧', xs/pay_sum*100 FROM bss_business_day_data WHERE service_name = '庐山服务区' AND delete_ts IS NULL ORDER BY oper_date DESC LIMIT 1 UNION ALL SELECT '金豆', jd/pay_sum*100 FROM bss_business_day_data WHERE service_name = '庐山服务区' AND delete_ts IS NULL ORDER BY oper_date DESC LIMIT 1;"
  },
  {
    "question": "统计2023年4月各服务区每日车流量趋势，按日期升序排列",
    "sql": "SELECT count_date AS 统计日期, service_area_name AS 服务区名称, SUM(customer_count) AS 总车流量 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE count_date BETWEEN '2023-04-01' AND '2023-04-30' AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY count_date, service_area_name ORDER BY 统计日期 ASC;"
  },
  {
    "question": "对比各服务区不同车辆类型占比，显示占比超过10%的车型",
    "sql": "SELECT service_area_name AS 服务区名称, car_type AS 车辆类型, SUM(customer_count) * 100.0 / (SELECT SUM(customer_count) FROM bss_car_day_count WHERE delete_ts IS NULL AND count_date = '2023-04-01') AS 占比百分比 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE count_date = '2023-04-01' AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY service_area_name, car_type HAVING SUM(customer_count) * 100.0 / (SELECT SUM(customer_count) FROM bss_car_day_count WHERE delete_ts IS NULL AND count_date = '2023-04-01') > 10 ORDER BY 服务区名称, 占比百分比 DESC;"
  },
  {
    "question": "按车流总量排名前5的服务区及对应地理坐标",
    "sql": "SELECT service_area_name AS 服务区名称, service_position AS 地理坐标, SUM(customer_count) AS 总车流量 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE count_date BETWEEN '2023-04-01' AND '2023-04-30' AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY service_area_name, service_position ORDER BY 总车流量 DESC LIMIT 5;"
  },
  {
    "question": "分析危化品车辆在Q2季度的月度分布变化",
    "sql": "SELECT DATE_TRUNC('month', count_date) AS 月份, SUM(customer_count) AS 危化品车流量 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE car_type = '危化品' AND count_date BETWEEN '2023-04-01' AND '2023-06-30' AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY DATE_TRUNC('month', count_date) ORDER BY 月份;"
  },
  {
    "question": "统计各服务区7座以上客车日均车流量（城际+过境），按均值降序",
    "sql": "SELECT service_area_name AS 服务区名称, AVG(customer_count) AS 日均客车流量 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE car_type IN ('城际', '过境') AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY service_area_name ORDER BY 日均客车流量 DESC;"
  },
  {
    "question": "查找车流密度超过1000辆/天的服务区及其地理坐标（2023年4月数据）",
    "sql": "SELECT service_area_name AS 服务区名称, service_position AS 地理坐标, SUM(customer_count) AS 总车流量 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE count_date BETWEEN '2023-04-01' AND '2023-04-30' AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY service_area_name, service_position HAVING SUM(customer_count) > 1000 ORDER BY 总车流量 DESC;"
  },
  {
    "question": "分析南昌地区服务区（坐标含115-116经度）车流月环比增长率",
    "sql": "WITH monthly_flow AS (SELECT DATE_TRUNC('month', count_date) AS 月份, SUM(customer_count) AS 月车流量 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE service_position LIKE '115%' OR service_position LIKE '116%' AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY DATE_TRUNC('month', count_date)) SELECT 月份, 月车流量, (月车流量 - LAG(月车流量,1) OVER (ORDER BY 月份)) / LAG(月车流量,1) OVER (ORDER BY 月份) * 100 AS 环比增长率 FROM monthly_flow ORDER BY 月份;"
  },
  {
    "question": "查找2023-04-15当天无车流记录的服务区清单",
    "sql": "SELECT service_area_name AS 服务区名称 FROM bss_service_area WHERE id NOT IN (SELECT DISTINCT service_area_id FROM bss_car_day_count WHERE count_date = '2023-04-15' AND delete_ts IS NULL) AND delete_ts IS NULL ORDER BY 服务区名称;"
  },
  {
    "question": "统计各季度各服务区大客车（城际+过境）占比变化趋势",
    "sql": "SELECT DATE_TRUNC('quarter', count_date) AS 季度, service_area_name AS 服务区名称, SUM(CASE WHEN car_type IN ('城际','过境') THEN customer_count ELSE 0 END) * 100.0 / SUM(customer_count) AS 大客车占比 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY DATE_TRUNC('quarter', count_date), service_area_name ORDER BY 季度, 大客车占比 DESC;"
  },
  {
    "question": "分析赣南地区（经度114-115，纬度24-28）各车型分布占比",
    "sql": "SELECT car_type AS 车辆类型, SUM(customer_count) AS 总数量, SUM(customer_count) * 100.0 / (SELECT SUM(customer_count) FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE service_position ~ '^11[4-5].*,2[4-7].*' AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL) AS 占比百分比 FROM bss_car_day_count LEFT JOIN bss_service_area ON bss_car_day_count.service_area_id = bss_service_area.id WHERE service_position ~ '^11[4-5].*,2[4-7].*' AND bss_car_day_count.delete_ts IS NULL AND bss_service_area.delete_ts IS NULL GROUP BY car_type ORDER BY 总数量 DESC;"
  },
  {
    "question": "统计2023年各公司下属服务区月均营收排名",
    "sql": "SELECT c.company_name AS 公司名称, EXTRACT(MONTH FROM b.oper_date) AS 月份, AVG(b.pay_sum) AS 月均营收 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL AND EXTRACT(YEAR FROM b.oper_date) = 2023 GROUP BY c.company_name, EXTRACT(MONTH FROM b.oper_date) ORDER BY 月份, 月均营收 DESC;"
  },
  {
    "question": "对比2023年Q1各公司客单价差异",
    "sql": "SELECT c.company_name AS 公司名称, SUM(b.pay_sum)/SUM(b.order_sum) AS 客单价 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL AND b.oper_date BETWEEN '2023-01-01' AND '2023-03-31' GROUP BY c.company_name ORDER BY 客单价 DESC;"
  },
  {
    "question": "分析2023年各公司服务区人流量与消费额变化趋势",
    "sql": "SELECT c.company_name AS 公司名称, EXTRACT(MONTH FROM b.oper_date) AS 月份, SUM(car.customer_count) AS 人流量, SUM(b.pay_sum) AS 总消费额 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id JOIN bss_car_day_count car ON s.id = car.service_area_id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL AND car.delete_ts IS NULL AND EXTRACT(YEAR FROM b.oper_date) = 2023 GROUP BY c.company_name, EXTRACT(MONTH FROM b.oper_date) ORDER BY 月份;"
  },
  {
    "question": "查询2023年营收TOP5服务区及所属公司",
    "sql": "SELECT s.service_name AS 服务区名称, c.company_name AS 公司名称, SUM(b.pay_sum) AS 总营收 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL AND EXTRACT(YEAR FROM b.oper_date) = 2023 GROUP BY s.service_name, c.company_name ORDER BY 总营收 DESC LIMIT 5;"
  },
  {
    "question": "比较2023年各公司支付宝支付占比",
    "sql": "SELECT c.company_name AS 公司名称, SUM(b.zfb)/SUM(b.pay_sum)*100 AS 支付宝占比 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL AND EXTRACT(YEAR FROM b.oper_date) = 2023 GROUP BY c.company_name ORDER BY 支付宝占比 DESC;"
  },
  {
    "question": "分析2023年各公司月营收环比增长率",
    "sql": "WITH monthly_revenue AS (SELECT c.company_name AS 公司名称, EXTRACT(MONTH FROM b.oper_date) AS 月份, SUM(b.pay_sum) AS 总营收 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL AND EXTRACT(YEAR FROM b.oper_date) = 2023 GROUP BY c.company_name, EXTRACT(MONTH FROM b.oper_date)) SELECT 公司名称, 月份, (总营收 / LAG(总营收,1) OVER (PARTITION BY 公司名称 ORDER BY 月份) -1)*100 AS 增长率 FROM monthly_revenue ORDER BY 公司名称, 月份;"
  },
  {
    "question": "查询2023年无营收记录的服务区",
    "sql": "SELECT s.service_name AS 服务区名称, c.company_name AS 公司名称 FROM bss_service_area s LEFT JOIN bss_company c ON s.company_id = c.id LEFT JOIN bss_business_day_data b ON s.service_area_no = b.service_no AND b.oper_date BETWEEN '2023-01-01' AND '2023-12-31' WHERE s.delete_ts IS NULL AND c.delete_ts IS NULL AND b.id IS NULL;"
  },
  {
    "question": "分析各公司现金支付比例分布",
    "sql": "SELECT c.company_name AS 公司名称, SUM(b.rmb)/SUM(b.pay_sum)*100 AS 现金占比 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL GROUP BY c.company_name ORDER BY 现金占比 DESC;"
  },
  {
    "question": "统计2023年各公司订单数量排名",
    "sql": "SELECT c.company_name AS 公司名称, SUM(b.order_sum) AS 总订单数 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL AND EXTRACT(YEAR FROM b.oper_date) = 2023 GROUP BY c.company_name ORDER BY 总订单数 DESC;"
  },
  {
    "question": "分析不同车辆类型下各公司客单价差异",
    "sql": "SELECT c.company_name AS 公司名称, car.car_type AS 车辆类型, SUM(b.pay_sum)/SUM(car.customer_count) AS 人均消费 FROM bss_business_day_data b JOIN bss_service_area s ON b.service_no = s.service_area_no JOIN bss_company c ON s.company_id = c.id JOIN bss_car_day_count car ON s.id = car.service_area_id WHERE b.delete_ts IS NULL AND s.delete_ts IS NULL AND c.delete_ts IS NULL AND car.delete_ts IS NULL GROUP BY c.company_name, car.car_type ORDER BY 公司名称, 人均消费 DESC;"
  },
  {
    "question": "统计各路线关联服务区最近30天单位车流营收（总营收/车流量），按效益降序排列前5",
    "sql": "SELECT r.route_name AS 路线名称, SUM(bd.pay_sum) / SUM(cd.customer_count) AS 单位车流营收 FROM bss_section_route_area_link l JOIN bss_section_route r ON l.section_route_id = r.id JOIN bss_business_day_data bd ON l.service_area_id = bd.service_no::varchar JOIN bss_car_day_count cd ON l.service_area_id = cd.service_area_id WHERE bd.oper_date >= CURRENT_DATE - INTERVAL '30 days' AND cd.count_date >= CURRENT_DATE - INTERVAL '30 days' GROUP BY r.route_name ORDER BY 单位车流营收 DESC LIMIT 5;"
  },
  {
    "question": "计算各路线覆盖率（关联服务区数/公司总服务区数）并展示差异对比",
    "sql": "SELECT r.route_name AS 路线名称, COUNT(l.service_area_id) * 1.0 / (SELECT COUNT(*) FROM bss_service_area sa WHERE sa.company_id = c.id AND sa.delete_ts IS NULL) AS 覆盖率 FROM bss_section_route_area_link l JOIN bss_section_route r ON l.section_route_id = r.id JOIN bss_service_area sa ON l.service_area_id = sa.id JOIN bss_company c ON sa.company_id = c.id GROUP BY r.route_name, c.id;"
  },
  {
    "question": "分析G45高速不同路段坪效（日均营收/服务区数量）的月度趋势变化",
    "sql": "SELECT EXTRACT(MONTH FROM bd.oper_date) AS 月份, s.section_name AS 路段, AVG(bd.pay_sum) / COUNT(DISTINCT sa.id) AS 坪效 FROM bss_section_route s JOIN bss_section_route_area_link l ON s.id = l.section_route_id JOIN bss_business_day_data bd ON l.service_area_id = bd.service_no::varchar JOIN bss_service_area sa ON l.service_area_id = sa.id WHERE s.section_name LIKE 'G45%' GROUP BY 月份, s.section_name ORDER BY 月份;"
  },
  {
    "question": "找出上月营收排名前5且车流密度高于平均值的标杆服务区及所属路线",
    "sql": "WITH avg_density AS (SELECT AVG(customer_count) AS avg_val FROM bss_car_day_count WHERE count_date >= '2023-03-01') SELECT sa.service_area_name AS 服务区, r.route_name AS 路线名称, SUM(bd.pay_sum) AS 总营收 FROM bss_business_day_data bd JOIN bss_service_area sa ON bd.service_no = sa.service_area_no::varchar JOIN bss_section_route_area_link l ON sa.id = l.service_area_id JOIN bss_section_route r ON l.section_route_id = r.id JOIN avg_density ad ON TRUE WHERE bd.oper_date >= '2023-03-01' GROUP BY sa.service_area_name, r.route_name HAVING SUM(bd.pay_sum) > (SELECT AVG(pay_sum) FROM bss_business_day_data WHERE oper_date >= '2023-03-01') AND SUM(customer_count) > ad.avg_val ORDER BY 总营收 DESC LIMIT 5;"
  },
  {
    "question": "对比不同公司管辖路线的服务区坪效差异（取最近一天完整数据）",
    "sql": "SELECT c.company_name AS 公司名称, r.route_name AS 路线名称, AVG(bd.pay_sum) / COUNT(DISTINCT sa.id) AS 日均坪效 FROM bss_section_route r JOIN bss_section_route_area_link l ON r.id = l.section_route_id JOIN bss_service_area sa ON l.service_area_id = sa.id JOIN bss_company c ON sa.company_id = c.id JOIN bss_business_day_data bd ON l.service_area_id = bd.service_no::varchar AND bd.oper_date = '2023-04-01' GROUP BY c.company_name, r.route_name;"
  },
  {
    "question": "统计各路线周末（周六日）与工作日营收差异率（（周末日均-工作日日均）/工作日日均）",
    "sql": "SELECT r.route_name AS 路线名称, (AVG(CASE WHEN EXTRACT(DOW FROM bd.oper_date) IN (6,0) THEN bd.pay_sum ELSE 0 END) - AVG(CASE WHEN EXTRACT(DOW FROM bd.oper_date) NOT IN (6,0) THEN bd.pay_sum ELSE 0 END)) / AVG(CASE WHEN EXTRACT(DOW FROM bd.oper_date) NOT IN (6,0) THEN bd.pay_sum ELSE 0 END) AS 差异率 FROM bss_section_route r JOIN bss_section_route_area_link l ON r.id = l.section_route_id JOIN bss_business_day_data bd ON l.service_area_id = bd.service_no::varchar GROUP BY r.route_name;"
  },
  {
    "question": "列出昌九路线所有关联服务区的3月人均消费（总营收/车流量）及同比增幅",
    "sql": "SELECT sa.service_area_name AS 服务区, SUM(bd.pay_sum) / SUM(cd.customer_count) AS 人均消费, (SUM(bd.pay_sum) FILTER (WHERE bd.oper_date BETWEEN '2023-03-01' AND '2023-03-31') / SUM(cd.customer_count) FILTER (WHERE cd.count_date BETWEEN '2023-03-01' AND '2023-03-31')) / (SUM(bd.pay_sum) FILTER (WHERE bd.oper_date BETWEEN '2022-03-01' AND '2022-03-31') / SUM(cd.customer_count) FILTER (WHERE cd.count_date BETWEEN '2022-03-01' AND '2022-03-31')) - 1 AS 同比增幅 FROM bss_section_route r JOIN bss_section_route_area_link l ON r.id = l.section_route_id JOIN bss_service_area sa ON l.service_area_id = sa.id JOIN bss_business_day_data bd ON sa.service_area_no::varchar = bd.service_no JOIN bss_car_day_count cd ON sa.id = cd.service_area_id WHERE r.route_name = '昌九' GROUP BY sa.service_area_name;"
  },
  {
    "question": "识别连续3天车流下降超过15%且营收同步下滑的服务区及所属路线",
    "sql": "WITH daily_flow AS (SELECT service_area_id, oper_date, customer_count, LAG(customer_count,1) OVER (PARTITION BY service_area_id ORDER BY oper_date) AS prev_day FROM bss_car_day_count WHERE count_date BETWEEN '2023-03-28' AND '2023-03-31') SELECT sa.service_area_name, r.route_name FROM daily_flow df JOIN bss_service_area sa ON df.service_area_id = sa.id JOIN bss_section_route_area_link l ON sa.id = l.service_area_id JOIN bss_section_route r ON l.section_route_id = r.id GROUP BY sa.service_area_name, r.route_name HAVING AVG((df.customer_count - df.prev_day)/df.prev_day) < -0.15 AND EXISTS (SELECT 1 FROM bss_business_day_data bd WHERE bd.service_no = sa.service_area_no::varchar AND bd.oper_date BETWEEN '2023-03-28' AND '2023-03-31' GROUP BY bd.service_no HAVING AVG((pay_sum - LAG(pay_sum,1) OVER())/LAG(pay_sum,1) OVER()) < 0);"
  },
  {
    "question": "分析危化品车辆占比对路线坪效的影响（按季度统计相关系数）",
    "sql": "SELECT 'Q' || EXTRACT(QUARTER FROM bd.oper_date) AS 季度, r.route_name AS 路线名称, CORR(CASE WHEN cd.car_type = '危化品' THEN cd.customer_count ELSE 0 END, bd.pay_sum) AS 相关系数 FROM bss_business_day_data bd JOIN bss_section_route_area_link l ON bd.service_no::varchar = l.service_area_id JOIN bss_section_route r ON l.section_route_id = r.id JOIN bss_car_day_count cd ON l.service_area_id = cd.service_area_id AND bd.oper_date = cd.count_date GROUP BY 季度, r.route_name;"
  },
  {
    "question": "输出九景高速各服务区近7天每日营收及路线累计覆盖率（开累服务区数/总规划数）",
    "sql": "SELECT sa.service_area_name AS 服务区, bd.oper_date AS 日期, bd.pay_sum AS 日营收, COUNT(*) OVER (ORDER BY sa.id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) / (SELECT COUNT(*) FROM bss_section_route_area_link l JOIN bss_section_route r ON l.section_route_id = r.id WHERE r.section_name = '九景') AS 累计覆盖率 FROM bss_section_route r JOIN bss_section_route_area_link l ON r.id = l.section_route_id JOIN bss_service_area sa ON l.service_area_id = sa.id JOIN bss_business_day_data bd ON sa.service_area_no::varchar = bd.service_no WHERE r.section_name = '九景' AND bd.oper_date >= CURRENT_DATE - INTERVAL '7 days' ORDER BY bd.oper_date;"
  },
  {
    "question": "统计各相邻服务区近30天车流总量对比，按日期分组展示趋势变化",
    "sql": "SELECT bcc.count_date AS 统计日期, bsam.service_name AS 服务区名称, SUM(bcc.customer_count) AS 总车流量 FROM bss_car_day_count bcc INNER JOIN bss_service_area_mapper bsam ON bcc.service_area_id = bsam.service_area_id WHERE bcc.delete_ts IS NULL AND bsam.delete_ts IS NULL AND bcc.count_date >= CURRENT_DATE - 30 GROUP BY bcc.count_date, bsam.service_name ORDER BY bcc.count_date DESC;"
  },
  {
    "question": "分析不同数据来源类别下服务区跨区消费金额占比（按微信+支付宝金额计算）",
    "sql": "SELECT bsam.source_system_type AS 数据来源, SUM(bbd.wx + bbd.zfb) AS 消费总额, COUNT(DISTINCT bsam.service_no) AS 服务区数量 FROM bss_business_day_data bbd INNER JOIN bss_service_area_mapper bsam ON bbd.service_no = bsam.service_no WHERE bbd.delete_ts IS NULL AND bsam.delete_ts IS NULL GROUP BY bsam.source_system_type ORDER BY 消费总额 DESC;"
  },
  {
    "question": "计算各服务区最近月份订单总数环比增长率（当前月/上月-1）",
    "sql": "WITH monthly_orders AS (SELECT service_name, EXTRACT(MONTH FROM oper_date) AS 月份, SUM(order_sum) AS 月订单数 FROM bss_business_day_data bbd INNER JOIN bss_service_area_mapper bsam ON bbd.service_no = bsam.service_no WHERE oper_date >= DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '2 months' GROUP BY service_name, EXTRACT(MONTH FROM oper_date))) SELECT service_name, 月份, 月订单数 / LAG(月订单数,1) OVER (PARTITION BY service_name ORDER BY 月份) - 1 AS 环比增长率 FROM monthly_orders WHERE 月份 <= EXTRACT(MONTH FROM CURRENT_DATE);"
  },
  {
    "question": "查询车流转化率TOP5服务区（订单总数/车流量）",
    "sql": "SELECT bsam.service_name, SUM(bbd.order_sum) / SUM(bcc.customer_count) AS 转化率 FROM bss_business_day_data bbd INNER JOIN bss_car_day_count bcc ON bbd.service_no = bsam.service_no INNER JOIN bss_service_area_mapper bsam ON bcc.service_area_id = bsam.service_area_id WHERE bbd.oper_date = CURRENT_DATE - 1 AND bcc.count_date = CURRENT_DATE - 1 GROUP BY bsam.service_name ORDER BY 转化率 DESC LIMIT 5;"
  },
  {
    "question": "统计不同车辆类型在各服务区的分布比例",
    "sql": "SELECT bsam.service_name AS 服务区名称, bcc.car_type AS 车辆类型, SUM(bcc.customer_count) AS 车辆数量, SUM(bcc.customer_count) * 100.0 / SUM(SUM(bcc.customer_count)) OVER (PARTITION BY bsam.service_name) AS 占比百分比 FROM bss_car_day_count bcc INNER JOIN bss_service_area_mapper bsam ON bcc.service_area_id = bsam.service_area_id WHERE bcc.delete_ts IS NULL GROUP BY bsam.service_name, bcc.car_type;"
  },
  {
    "question": "分析国庆黄金周期间各服务区消费金额同比去年增长情况",
    "sql": "SELECT this_year.service_name, SUM(this_year.pay_sum) AS 当前年消费额, SUM(last_year.pay_sum) AS 去年消费额, (SUM(this_year.pay_sum)/SUM(last_year.pay_sum)-1)*100 AS 增长率 FROM (SELECT * FROM bss_business_day_data WHERE oper_date BETWEEN '2023-10-01' AND '2023-10-07') this_year INNER JOIN (SELECT * FROM bss_business_day_data WHERE oper_date BETWEEN '2022-10-01' AND '2022-10-07') last_year ON this_year.service_no = last_year.service_no INNER JOIN bss_service_area_mapper bsam ON this_year.service_no = bsam.service_no GROUP BY this_year.service_name;"
  },
  {
    "question": "查询城际车辆占比超过30%的服务区清单",
    "sql": "SELECT bsam.service_name FROM bss_car_day_count bcc INNER JOIN bss_service_area_mapper bsam ON bcc.service_area_id = bsam.service_area_id WHERE bcc.car_type = '城际' AND bcc.count_date = CURRENT_DATE - 1 GROUP BY bsam.service_name HAVING SUM(bcc.customer_count) * 100.0 / SUM(SUM(bcc.customer_count)) OVER (PARTITION BY bsam.service_name) > 30;"
  },
  {
    "question": "统计各档口类型订单数量分布（按微信、支付宝、现金分类）",
    "sql": "SELECT branch_name AS 档口名称, SUM(wx_order) AS 微信订单, SUM(zf_order) AS 支付宝订单, SUM(rmb_order) AS 现金订单 FROM bss_business_day_data WHERE delete_ts IS NULL GROUP BY branch_name ORDER BY 微信订单 DESC;"
  },
  {
    "question": "分析相邻服务区'南昌南'和'宜春'在2023年Q2季度的消费结构差异",
    "sql": "SELECT bsam.service_name AS 服务区, SUM(bbd.wx) / SUM(bbd.pay_sum) AS 微信占比, SUM(bbd.zfb) / SUM(bbd.pay_sum) AS 支付宝占比, SUM(bbd.rmb) / SUM(bbd.pay_sum) AS 现金占比 FROM bss_business_day_data bbd INNER JOIN bss_service_area_mapper bsam ON bbd.service_no = bsam.service_no WHERE bsam.service_name IN ('南昌南服务区','宜春服务区') AND bbd.oper_date BETWEEN '2023-04-01' AND '2023-06-30' GROUP BY bsam.service_name;"
  },
  {
    "question": "查询连续3天车流量下降且订单转化率低于行业均值的异常服务区",
    "sql": "WITH daily_stats AS (SELECT bsam.service_name, bcc.count_date, SUM(bcc.customer_count) AS 车流量, SUM(bbd.order_sum) AS 订单数 FROM bss_car_day_count bcc INNER JOIN bss_business_day_data bbd ON bcc.count_date = bbd.oper_date INNER JOIN bss_service_area_mapper bsam ON bcc.service_area_id = bsam.service_area_id GROUP BY bsam.service_name, bcc.count_date), avg_conversion AS (SELECT AVG(订单数 * 1.0 / 车流量) AS 行业均值 FROM daily_stats) SELECT ds.service_name FROM daily_stats ds, avg_conversion ac WHERE ds.订单数 * 1.0 / ds.车流量 < ac.行业均值 AND ds.count_date >= CURRENT_DATE - 3 GROUP BY ds.service_name HAVING COUNT(*) = 3;"
  }
]